<ion-content class="ion-padding">

  <!-- 1) Acciones -->
  <div class="actions-grid">
    <ion-card class="action-card">
      <ion-card-content>
        <div class="action-title">Solicitar Retiro</div>
        <div class="action-sub">Retiro de mercadería hacia bodega</div>
        <ion-button expand="block" (click)="goToRetiro()">
          Solicitar Retiro
        </ion-button>
      </ion-card-content>
    </ion-card>

    <ion-card class="action-card">
      <ion-card-content>
        <div class="action-title">Solicitar Despacho</div>
        <div class="action-sub">Despacho a cliente final</div>
        <ion-button expand="block" (click)="goToDespacho()">
          Solicitar Despacho
        </ion-button>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- 2) Filtros compactos -->
  <ion-card>
    <ion-card-content class="filters">
      <ion-item lines="none">
        <ion-label>Tipo</ion-label>
        <ion-select [(ngModel)]="filters.tipo">
          <ion-select-option value="ALL">Todos</ion-select-option>
          <ion-select-option value="DESPACHO">Despacho</ion-select-option>
          <ion-select-option value="RETIRO">Retiro</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item lines="none">
        <ion-label>Estado</ion-label>
        <ion-select [(ngModel)]="filters.estado">
          <ion-select-option value="ALL">Todos</ion-select-option>
          <ion-select-option value="SOLICITADO">Solicitado</ion-select-option>
          <ion-select-option value="EN_PREPARACION">En preparación</ion-select-option>
          <ion-select-option value="PREPARADO">Preparado</ion-select-option>
          <ion-select-option value="EN_TRANSITO">En tránsito</ion-select-option>
          <ion-select-option value="ENTREGADO">Entregado</ion-select-option>
          <ion-select-option value="FALLIDO">Fallido</ion-select-option>
          <ion-select-option value="CANCELADO">Cancelado</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item lines="none" button detail="false" (click)="openDateModal()">
        <ion-label>Fechas</ion-label>
        <ion-note slot="end">
          {{ filters.desde ? (filters.desde | date:'dd/MM/yyyy') : 'Desde' }}
          -
          {{ filters.hasta ? (filters.hasta | date:'dd/MM/yyyy') : 'Hasta' }}
        </ion-note>
      </ion-item>

      <ion-button
        *ngIf="filters.desde || filters.hasta"
        size="small"
        fill="clear"
        (click)="clearAppliedDates()">
            Quitar fechas
      </ion-button>


      <ion-item lines="none">
        <ion-label position="stacked">Buscar</ion-label>
        <ion-input
          placeholder="OD-2026-0012 / destinatario..."
          [(ngModel)]="filters.q"
          (ionInput)="onSearch()">
        </ion-input>
      </ion-item>

      <div class="filter-actions">
        <ion-button fill="outline" (click)="resetFilters()">Limpiar</ion-button>
        <ion-button (click)="reload()">Aplicar</ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- 3) Historial -->
  <div class="section-title">Historial de Órdenes</div>

  <ion-card *ngFor="let o of orders" class="order-card" (click)="openOrder(o)">
    <ion-card-content>
      <div class="order-row">
        <div class="order-code">{{ o.codigo }}</div>
        <ion-badge [color]="badgeColor(o.estado)">{{ labelEstado(o.estado) }}</ion-badge>
      </div>

      <div class="order-meta">
        <span class="pill">{{ o.tipo }}</span>
        <span>{{ o.fecha | date:'dd/MM/yyyy HH:mm' }}</span>
        <span *ngIf="o.destino">• {{ o.destino }}</span>
        <span *ngIf="o.items">• {{ o.items }} items</span>
      </div>
    </ion-card-content>
  </ion-card>

  <ion-card *ngIf="!loading && orders.length === 0">
    <ion-card-content>No hay órdenes con esos filtros.</ion-card-content>
  </ion-card>

</ion-content>

<!-- Modal de fechas (no visible hasta abrir) -->
<ion-modal [isOpen]="dateModalOpen" (didDismiss)="dateModalOpen=false">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Filtrar por fechas</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="dateModalOpen=false">Cerrar</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <ion-item>
        <ion-label position="stacked">Desde</ion-label>
        <ion-datetime presentation="date" [(ngModel)]="tempDesde"></ion-datetime>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Hasta</ion-label>
        <ion-datetime presentation="date" [(ngModel)]="tempHasta"></ion-datetime>
      </ion-item>

      <ion-button expand="block" (click)="applyDates()">Aplicar fechas</ion-button>
      <ion-button expand="block" fill="outline" (click)="clearDates()">Limpiar fechas</ion-button>
    </ion-content>
  </ng-template>
</ion-modal>
