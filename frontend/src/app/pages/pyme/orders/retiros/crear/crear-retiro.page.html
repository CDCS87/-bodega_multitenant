<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/pyme/orders"></ion-back-button>
    </ion-buttons>
    <ion-title>Solicitar Retiro</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">

  <div *ngIf="creado" class="animate__animated animate__fadeIn">
    <ion-card class="ion-text-center card-exito">
      <ion-card-header>
        <ion-card-subtitle color="success">隆SOLICITUD EXITOSA!</ion-card-subtitle>
        <ion-card-title class="codigo-grande">{{ creado.codigo }}</ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <div class="qr-container">
          <img *ngIf="qrDataUrl" [src]="qrDataUrl" alt="C贸digo QR" />
          <ion-spinner *ngIf="!qrDataUrl" name="dots"></ion-spinner>
        </div>

        <div class="detalle-lista">
          <h6> Contenido del Paquete:</h6>
          <ion-list lines="none">
            <ion-item *ngFor="let item of itemsRetiro" class="item-compacto">
              <ion-label>
                <h2>{{ item.nombre }}</h2>
                <p>Cant: {{ item.cantidad }}</p>
              </ion-label>
            </ion-item>
          </ion-list>
        </div>

        <div class="botones-accion">
          <ion-button expand="block" color="primary" (click)="imprimirQR()">
            <ion-icon slot="start" name="print-outline"></ion-icon>
            Imprimir Solicitud
          </ion-button>
          <ion-button expand="block" fill="outline" color="medium" (click)="nuevaSolicitud()">
            <ion-icon slot="start" name="add-circle-outline"></ion-icon>
            Nueva Solicitud
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <div *ngIf="!creado">
    
    <ion-card>
      <ion-card-header>
        <ion-card-subtitle>驴D贸nde retiramos?</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <ion-item lines="none">
          <ion-label>Usar direcci贸n registrada</ion-label>
          <ion-toggle [(ngModel)]="usarDireccionRegistrada" (ionChange)="toggleDireccion()"></ion-toggle>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Direcci贸n Exacta</ion-label>
          <ion-input [(ngModel)]="form.direccion" placeholder="Ej: Calle Falsa 123"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Comuna</ion-label>
          <ion-input [(ngModel)]="form.comuna" placeholder="Ej: Springfield"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Referencia (Opcional)</ion-label>
          <ion-input [(ngModel)]="form.referencia" placeholder="Ej: Port贸n negro, timbre malo , departamento 205"></ion-input>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <ion-card>
      <ion-card-header>
        <ion-card-title>Productos a Retirar</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        
        <ion-button expand="block" fill="outline" (click)="setOpen(true)">
          <ion-icon slot="start" name="search-outline"></ion-icon>
          Buscar Producto
        </ion-button>

        <ion-list *ngIf="itemsRetiro.length > 0">
          <ion-list-header>
            <ion-label>Lista de Empaque</ion-label>
          </ion-list-header>

          <ion-item-sliding *ngFor="let item of itemsRetiro; let i = index">
            <ion-item>
              <ion-icon slot="start" name="cube-outline"></ion-icon>
              <ion-label>
                <h2>{{ item.nombre }}</h2>
                <p>SKU: {{ item.sku }}</p>
              </ion-label>
              <ion-badge slot="end" color="dark">x{{ item.cantidad }}</ion-badge>
            </ion-item>
            <ion-item-options side="end">
              <ion-item-option color="danger" (click)="eliminarItem(i)">
                <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
              </ion-item-option>
            </ion-item-options>
          </ion-item-sliding>
        </ion-list>

        <p *ngIf="itemsRetiro.length === 0" class="ion-text-center ion-padding text-muted">
          No hay productos agregados a煤n.
        </p>

      </ion-card-content>
    </ion-card>

    <ion-card>
      <ion-card-content>
        <ion-item>
          <ion-label position="stacked">Horario Preferido</ion-label>
          <ion-select [(ngModel)]="form.rango" interface="popover">
            <ion-select-option value="CORTE_1">Ma帽ana (09:00 - 13:00)</ion-select-option>
            <ion-select-option value="CORTE_2">Tarde (14:00 - 18:00)</ion-select-option>
          </ion-select>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Observaciones Generales</ion-label>
          <ion-input [(ngModel)]="form.observaciones"></ion-input>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <div class="ion-padding">
      <ion-button expand="block" size="large" (click)="submit()" [disabled]="loading">
        <ion-spinner *ngIf="loading" name="crescent"></ion-spinner>
        <span *ngIf="!loading">Crear Solicitud</span>
      </ion-button>
    </div>

  </div>
<ion-modal [isOpen]="isModalOpen" (didDismiss)="setOpen(false)">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Buscar Producto</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="setOpen(false)">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
        <ion-toolbar>
          <ion-searchbar placeholder="Nombre, SKU o C贸digo de barras..." (ionInput)="buscarProducto($event)"></ion-searchbar>
        </ion-toolbar>
      </ion-header>

      <ion-content>
        <ion-list>
          <ion-item *ngFor="let p of productosFiltrados" button (click)="seleccionarProducto(p)">
            <ion-label>
              <h2>{{ p.nombre }}</h2>
              <p>SKU: {{ p.sku }} | Stock: {{ p.stock_actual }}</p>
            </ion-label>
            <ion-icon slot="end" name="add-circle-outline" color="primary"></ion-icon>
          </ion-item>
        </ion-list>
        
        <div *ngIf="productosFiltrados.length === 0" class="ion-text-center ion-padding">
          <p>Escribe para buscar productos...</p>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  </ion-content>




